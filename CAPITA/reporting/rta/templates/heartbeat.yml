AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Scheduled special Heart Beat for RTA

Parameters:
  pEnvironment:
    Type: String
    Default: DEV
    Description: Environment label to apply to resources naming
  pEnvironmentLowerCase:
    Type: String
    Default: dev
    Description: Environment label to apply to resources naming, lowercase
  pDepartment:
    Type: String
    Default: ccm
    Description: Department identifier for unique bucket naming, lowercase
  pTargetLambdaArn:
    Type: String
    Description: Arn for the target lambda
  pStartSchedule:
    Type: String
    Default: "cron(0 6 * * ? *)"
    Description: Cron schedule for starting the heart beats
  pStopSchedule:
    Type: String
    Default: "cron(0 22 * * ? *)"
    Description: Cron schedule for stopping the heart beats

Resources:

  HeartBeat:
    Type: AWS::Events::Rule
    Properties:
      ScheduleExpression: rate(1 minute)
      State: DISABLED
      Targets:
        - Arn: !Ref pTargetLambdaArn
          Id: heartbeats
          Input: "{\"EventType\":\"SP_HEART_BEAT\"}"

  HeartBeatsToLambdaPermission:
    Type: AWS::Lambda::Permission
    DependsOn: [HeartBeat]
    Properties:
      FunctionName: !Ref pTargetLambdaArn
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt HeartBeat.Arn

  # Schedule START / STOP

  ScheduleHeartBeatsLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "lmbRtaHbScheduler-${pDepartment}-${pEnvironment}"
      Handler: lambda_handler.handler
      Runtime: python3.6
      Timeout: 180
      Policies:
        - AWSLambdaExecute
        - CloudWatchEventsFullAccess
      CodeUri: ../src/heartbeats/code
      Environment:
        Variables:
          HB: !Ref HeartBeat
          LOGGING_LEVEL: "20"

  StartHeartBeatSchedule:
    Type: AWS::Events::Rule
    Properties:
      # Start heart beats at 6am daily
      ScheduleExpression: !Ref pStartSchedule
      # ScheduleExpression: "cron(*/2 * * * ? *)"
      State: ENABLED
      Targets:
        - Arn: !GetAtt ScheduleHeartBeatsLambda.Arn
          Id: start-heartbeats
          Input: "{\"schedule\": \"start\"}"

  StartSchedulePermission:
    Type: AWS::Lambda::Permission
    DependsOn: [StartHeartBeatSchedule, ScheduleHeartBeatsLambda]
    Properties:
      FunctionName: !Ref ScheduleHeartBeatsLambda
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt StartHeartBeatSchedule.Arn

  StopHeartBeatSchedule:
    Type: AWS::Events::Rule
    Properties:
      # Stop heart beats at 10pm daily
      ScheduleExpression: !Ref pStopSchedule
      # ScheduleExpression: "cron(*/2 * * * ? *)"
      State: ENABLED
      Targets:
        - Arn: !GetAtt ScheduleHeartBeatsLambda.Arn
          Id: stop-heartbeats
          Input: "{\"schedule\": \"stop\"}"

  StopSchedulePermission:
    Type: AWS::Lambda::Permission
    DependsOn: [StopHeartBeatSchedule, ScheduleHeartBeatsLambda]
    Properties:
      FunctionName: !Ref ScheduleHeartBeatsLambda
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt StopHeartBeatSchedule.Arn
