<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CAPITA CONNECT RTA DASH</title>


    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.3/js/tether.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.21.0/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.13/vue.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue-good-table@2.16.0/dist/vue-good-table.min.js"></script>


    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>


    <!-- Latest compiled and minified CSS -->
    <link type="text/css" rel="stylesheet" href="//unpkg.com/bootstrap/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="css/style.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vue-good-table@2.16.0/dist/vue-good-table.min.css">


    
<style>


    .vspace {
        margin-top: 50px
    }


    .btnDark {
        color:#497d91
    }
    .actionBtn {
        cursor: pointer
    }
    .outer-shadow {
        -webkit-box-shadow: 2px 5px 15px 0px rgba(0, 0, 0, 0.5);
        -moz-box-shadow: 2px 5px 15px 0px rgba(0, 0, 0, 0.5);
        box-shadow: 2px 5px 15px 0px rgba(0, 0, 0, 0.5);
    }


</style>




</head>
<body>




<div class="container-fluid text-center mx-auto" id="vapp" style="position:relative" v-cloak>

    <div class="row">
        <div class="col text-left"><img src="img/capita.png" style="height:30px"></div>
        <div class="col text-right" v-if="isAuthenticated">
           
            
            <div class="dropdown">
                 Signed in as  <span style="cursor: pointer" class="dropdown-toggle" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    {{username}}
                </button>
                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                    <a class="dropdown-item" href="#" @click="changePasswordFlow()">Change password</a>
                    <a class="dropdown-item" href="#" @click="signout()">Sign out</a>
                </div>
            </div>
            
            
            <!--<span style="font-size:8pt;font-weight:bold">{{username}}</span>
            <button @click="signout()" class="btn btn-sm btn-primary btn-signin">&nbsp;signout&nbsp;</button>
            -->
        </div>
    </div>


    <!-- SIGN IN COMPONENT -->
    <div class=container v-if="doSignin">
        <div class="card card-container">
            <img id="profile-img" class="profile-img-card" src="//ssl.gstatic.com/accounts/ui/avatar_2x.png" />
            <p id="profile-name" class="profile-name-card" style="color:#005177">Log in to CAPITA Connect RTA</p>
            <p v-if="message" id="profile-name" class="profile-name-card" style="color:#808080; font-size:8pt">{{message}}</p>
            <form class="form-signin" @submit.prevent="signin">
                <span id="reauth-email" class="reauth-email"></span>
                <input v-model="username" type="text" id="inputUsername" class="form-control" placeholder="Username" required autofocus>
                <input v-model="passwd" type="password" id="inputPassword" class="form-control" placeholder="Password" required>
                
                <div id="remember" class="checkbox">
                    <label>
                        <input v-model="rememberMe" type="checkbox" value="remember-me"> Remember me
                    </label>
                </div>
                
                <span style="color:red;font-size:8pt" v-if="auth_fail">Username or password not recognised</span><br>
                <button class="btn btn-lg btn-primary btn-block btn-signin" type="submit">Sign in</button>
            </form><!-- /form -->
            
            <a href="#" class="forgot-password" @click="forgotPasswordFlow()">
                Forgot the password?
            </a>
            
        </div><!-- /card-container -->
    </div>
    <!-- /SIGN IN COMPONENT -->



    <!-- CHANGE PW COMPONENT - CHALLENGE -->
    <div class=container v-if="newPasswordRequired">
        <div class="card card-container">
            <img id="profile-img" class="profile-img-card" src="//ssl.gstatic.com/accounts/ui/avatar_2x.png" />
            <p id="profile-name" class="profile-name-card"></p>
            <form class="form-signin" @submit.prevent="signin">
                <span id="reauth-email" class="reauth-email"></span>
                <input v-model="username" type="text" id="inputUsername" class="form-control" placeholder="Username" required autofocus>
                <br><span>&nbsp;</span><br>
                <span>Please enter a new password:</span>
                <input v-model="newpw" type="password" id="newPassword" class="form-control" placeholder="New Password" required>
                <span>{{newPwMessage}}</span>
                <br><span>&nbsp;</span><br>
                <button class="btn btn-lg btn-primary btn-block btn-signin" type="submit">Change Password</button>
            </form><!-- /form -->
        </div><!-- /card-container -->
    </div>
    <!-- /CHANGE PW COMPONENT - CHALLENGE -->



    <!-- CHANGE PW COMPONENT - USER REQUESTED -->
    <div class=container v-if="changePwFlowState > -1">
        <div class="card card-container">
            <img id="profile-img" class="profile-img-card" src="//ssl.gstatic.com/accounts/ui/avatar_2x.png" />
            <p id="profile-name" class="profile-name-card"></p>
            <form class="form-signin" @submit.prevent="changePasswordFlow">
                <span>Old password:</span>
                <input v-model="passwd" type="password" id="inputOldPassword" class="form-control" placeholder="Original Password" required autofocus>
                
                <span>Please enter a new password:</span>
                <input v-model="newpw" type="password" id="newPassword" class="form-control" placeholder="New Password" required>
                <span>{{changePwMessage}}</span>
                <br><span>&nbsp;</span><br>
                <button class="btn btn-lg btn-primary btn-block btn-signin" type="submit">Change Password</button>
                <a href="#" @click="changePwCancel()">Cancel</span>
            </form><!-- /form -->
        </div><!-- /card-container -->
    </div>
    <!-- /CHANGE PW COMPONENT - USER REQUESTED -->


    <!-- FORGOT PW COMPONENT -->
    <div class=container v-if="forgotPwFlowState > -1">
        <div class="card card-container">
            <img id="profile-img" class="profile-img-card" src="//ssl.gstatic.com/accounts/ui/avatar_2x.png" />
            <p id="profile-name" class="profile-name-card"></p>
            <form class="form-signin" @submit.prevent="forgotPasswordFlow">
                <span id="reauth-email" class="reauth-email"></span>
                <input v-model="email" type="text" id="inputEmail" class="form-control" placeholder="Enter your email address" required autofocus>
                <br>
                <span v-if="forgotPwMessage">{{forgotPwMessage}}</span>
                <template v-if="forgotPwFlowState > 0">
                    <input v-model="verificationCode" type="text" id="inputVerificationCode" class="form-control" placeholder="Verification code">
                    <input v-model="newpw" type="password" id="newPassword" class="form-control" placeholder="New Password">
                    <br>
                </template>

                <button class="btn btn-lg btn-primary btn-block btn-signin" type="submit">{{forgotPwAction}}</button>
                <template v-if="forgotPwFlowState == 3">
                    <button class="btn btn-lg btn-primary btn-block btn-signin" @click="sendVerificationCode()">Send new code</button>
                </template>
                <a href="#" @click="forgotPwCancel()">Cancel</span>
            </form><!-- /form -->
        </div><!-- /card-container -->
    </div>
    <!-- /FORGOT PW COMPONENT -->


</div>




<script src="https://cdnjs.cloudflare.com/ajax/libs/aws-sdk/2.388.0/aws-sdk.js"></script>
<script src="js/aws-cognito-sdk.min.js"></script>
<script src="js/amazon-cognito-identity.min.js"></script>
<script src="js/config.js"></script>
<script>

    axios.defaults.headers.post['Content-Type'] = 'application/json';
    let pwPolicy = "Your password needs to be at least 8 characters and contain lower and upper case and at least one symbol and one number";

    var poolData = {
        UserPoolId: _config.cognito.userPoolId,
        ClientId: _config.cognito.userPoolClientId
    };
    var userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);

    function createCognitoUser(email) {
        return new AmazonCognitoIdentity.CognitoUser({
            Username: email,
            Pool: userPool
        });
    }

    let api = window._config.api.invokeUrl

    let vapp = new Vue({

        el: "#vapp",
        data: {
            doSignin: true,
            cognitoUser: null,
            userAttributes: null,
            isAuthenticated: false,
            newPasswordRequired: false,
            newPwMessage: '',
            username: '',
            passwd: '',
            newpw: null,
            auth_fail: false,
            rememberMe: false,
            changePwFlowState: -1,
            changePwMessage: '',
            forgotPwFlowState: -1,
            forgotPwAction: '',
            forgotPwEnterCode: false,
            forgotPwMessage: '',
            email: '',
            verificationCode: '',
            message: ''
        },
        computed: {},
        watch: {
            forgotPwFlowState: function() {
                if (this.forgotPwFlowState == 0)
                    this.forgotPwAction = "Send me a verification code";
                if (this.forgotPwFlowState == 1)
                    this.forgotPwAction = "Change password";                 
            }
        },
        methods: {

            clean : function() {
                if (this.cognitoUser)
                    this.cognitoUser.clearCachedTokens()

                this.cognitoUser = null;
                this.isAuthenticated = false;
                this.username = '';
                this.passwd = '';
                this.newpw = null; 
                this.rememberMe = false;
                axios.defaults.headers.common['Authorization'] = null;
                this.doSignin = true;
                
                this.message = '';
                this.verificationCode = '';
                this.email = '';
                this.forgotPwFlowState = -1;
                this.changePwFlowState = -1;
                this.changePwMessage = '';
                
            },

            hello: function() {
                console.log("Auth token:", axios.defaults.headers.common['Authorization']);
                axios.post(_config.api.invokeUrl, {'message':'hello'})
                .then(result => console.log("Success!", result))
                .catch(e => console.log("Error:", e))
            },


            refresh: function() {

                this.cognitoUser = userPool.getCurrentUser();
                console.log("Cognito User: ", this.cognitoUser);
                if (this.cognitoUser) {
                    this.cognitoUser.getSession((err,session) => {
                        console.log("Session", session);
                        id_token = session.idToken.getJwtToken();
                        console.log("ID token: ", id_token);
                        axios.defaults.headers.common['Authorization'] = id_token;
                        vapp.isAuthenticated = true;
                        vapp.username = vapp.cognitoUser.getUsername();
                        vapp.rememberMe = true;
                        vapp.doSignin = false;
                        
                    });
                } else {
                    console.log("No user... please sign in");
                    vapp.doSignin = true;
                }
            },

            signin: function() {
                let cognitoUser = createCognitoUser(this.username);
                console.log("Attempting to log in");
                let authenticationDetails = new AmazonCognitoIdentity.AuthenticationDetails({
                    Username: vapp.username,
                    Password: vapp.passwd
                });
                this.auth_fail = false;

                cognitoUser.authenticateUser(authenticationDetails, {
                    onSuccess: function(result) { 
                        console.log("Successfully logged in", result);
                        cognitoUser.getSession( function(e,session) {
                            axios.defaults.headers.common['Authorization'] = session.getIdToken().getJwtToken();
                        });
                        
                        vapp.isAuthenticated = true;
                        vapp.newPasswordRequired = false;
                        vapp.cognitoUser = cognitoUser;
                        vapp.doSignin = false;
                    },
                    onFailure: function(err) {
                        console.log("Unable to log in:", err);
                        vapp.cognitoUser = null;
                        vapp.isAuthenticated = false;
                        vapp.auth_fail = true;
                    },
                    newPasswordRequired: function(userAttributes, reqAttr) {
                        console.log("Password change required");
                        vapp.isAuthenticated = false;
                        vapp.newPasswordRequired = true;
                        vapp.doSignin = false;
                        
                        if (vapp.newpw) {
                            console.log("Changing password...");
                            delete userAttributes.email_verified;
                            cognitoUser.completeNewPasswordChallenge(vapp.newpw, userAttributes, this);
                        } else 
                            console.log("Presenting change password form...");
                    }
                });
            },

            signout: function() {
                if (userPool.getCurrentUser()) {
                    userPool.getCurrentUser().signOut();
                    this.clean();
                    console.log("Logged out...");
                } else {
                    console.log("Not logged in...");
                }
            },

            changePasswordFlow: function() {
                this.doSignin = false;
                this.changePwFlowState++;

                if (this.changePwFlowState == 0)
                    this.passwd = "";

                if (this.changePwFlowState > 0) {

                    this.cognitoUser.changePassword(this.passwd, this.newpw, function(err, result) {

                        if (err) {
                            console.log(err);
                            if (err.code == "NotAuthorizedException" || 
                                (err.code == "InvalidParameterException" && err.message.includes("previousPassword")))
                                vapp.changePwMessage = "Your original password is not correct, please check and try again"
                            else if (err.code == "LimitExceededException")
                                vapp.changePwMessage = "Too many password change attempts - try again later!"
                            else
                                vapp.changePwMessage = pwPolicy;
                            this.changePwFlowState = 0;
                        } else {
                            console.log(result);
                            vapp.clean();
                            vapp.message = "Password changed! Please log in again";
                        }
                    });
                }
                
            },

            changePwCancel: function() { this.changePwFlowState = -1 },

            sendVerificationCode: function() {
                this.cognitoUser = createCognitoUser(this.email);
                    this.cognitoUser.forgotPassword({
                        onSuccess: function(data) {
                            console.log("forgot password flow started");
                        },
                        onFailure: function(err) {
                            console.log(err);
                            vapp.forgotPwMessage = err.message;
                            vapp.forgotPwFlowState--;
                        },
                        inputVerificationCode: function(data) {
                            console.log("Code sent to "+ vapp.email);
                            vapp.forgotPwMessage = "A verification code has been sent to "+ vapp.email;
                        }
                    })  
            },

            forgotPwCancel: function() { this.forgotPwFlowState = -1; this.doSignin = true; },
            forgotPasswordFlow: function() {
                this.doSignin = false;
                console.log("Forget password, state = "+ this.forgotPwFlowState);

                this.forgotPwFlowState++;

                if (this.forgotPwFlowState == 1) {
                    this.sendVerificationCode();
                 }
                else if (this.forgotPwFlowState >= 2) {
                    this.cognitoUser.confirmPassword(this.verificationCode, this.newpw, {
                        onSuccess: function(data) {
                            console.log("Password updated");
                            vapp.clean();
                            vapp.message = "Password updated!";
                        },
                        onFailure: function(err) {
                            console.log(err);
                            vapp.forgotPwFlowState--;
                            if (err.code == "ExpiredCodeException") {
                                vapp.forgotPwMessage = "Verification code has expired";
                                vapp.forgotPwFlowState = 1;
                            } else if (err.code == "CodeMismatchException") {
                                vapp.forgotPwMessage = "Verification code incorrect";
                                vapp.forgotPwFlowState = 3;
                            }
                            else {
                                vapp.forgotPwMessage = pwPolicy;
                            }
                        }
                    })
                }

            }
        }
    });


    $(document).ready( function() {
        // attempt to reuse existing token...
        vapp.refresh();
        window.onunload =function(){
            if (!vapp.rememberMe)
                vapp.signout();
        }
    })
</script>

</body>
</html>